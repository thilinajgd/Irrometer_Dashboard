<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Sensor Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0px rgba(0, 135, 90, 0.4); }
            100% { box-shadow: 0 0 0 10px rgba(0, 135, 90, 0); }
        }
        .pulse-on-update { animation: pulse-ring 0.6s ease-out; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-[#2a4d69] tracking-tight">
            ðŸ’§ <span class="text-[#00875a]">Soil Health</span> Monitoring
        </h1>
        <p class="text-gray-500 mt-2 text-lg">Real-time Watermark Sensor Readings</p>
    </header>

    <div id="dashboard-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">

        <!-- Resistance Card -->
        <div id="resistance-card" class="data-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col justify-between">
            <p class="text-sm font-semibold uppercase text-gray-500">Resistance</p>
            <div class="flex items-end justify-between mt-2">
                <div id="resistance" class="value text-5xl font-bold text-gray-800">--</div>
                <span class="text-xl font-medium text-gray-400">k&Omega;</span>
            </div>
            <div id="resistance-timestamp" class="text-xs text-gray-400 mt-2">--</div>
        </div>

        <!-- Soil Tension Card -->
        <div id="centibar-card" class="data-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col justify-between">
            <p class="text-sm font-semibold uppercase text-gray-500">Soil Tension</p>
            <div class="flex items-end justify-between mt-2">
                <div id="centibar" class="value text-5xl font-bold text-gray-800">--</div>
                <span class="text-xl font-medium text-gray-400">cbar</span>
            </div>
            <div id="centibar-timestamp" class="text-xs text-gray-400 mt-2">--</div>
        </div>

        <!-- Temperature Card -->
        <div id="temperature-card" class="data-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col justify-between">
            <p class="text-sm font-semibold uppercase text-gray-500">Temperature</p>
            <div class="flex items-end justify-between mt-2">
                <div id="temperature" class="value text-5xl font-bold text-gray-800">--</div>
                <span class="text-xl font-medium text-gray-400">Â°C</span>
            </div>
            <div id="temperature-timestamp" class="text-xs text-gray-400 mt-2">--</div>
        </div>

        <!-- Status Card -->
        <div id="status-card" class="data-card p-6 rounded-xl shadow-lg transition duration-300 transform scale-100 ring-2 ring-transparent flex flex-col justify-between">
            <p class="text-sm font-semibold uppercase text-white">Irrigation Status</p>
            <div id="status" class="value text-4xl font-extrabold mt-2 text-white">--</div>
            <div id="status-timestamp" class="text-xs text-white mt-2">--</div>
        </div>

    </div>

    <footer class="text-center mt-12 text-sm text-gray-400">
        <p>Data provided by Irrometer Watermark Sensor via Firebase Realtime Database.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD72NRZtJ5s_1Trv1jBbISvz80ni1uwne0",
            authDomain: "irrometer-watermark-sensor.firebaseapp.com",
            databaseURL: "https://irrometer-watermark-sensor-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "irrometer-watermark-sensor",
            storageBucket: "irrometer-watermark-sensor.firebasestorage.app",
            messagingSenderId: "81648679067",
            appId: "1:81648679067:web:1f473773a7a914f24fae3e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const sensorRef = ref(db, "watermark_sensor");

        const resistanceEl = document.getElementById("resistance");
        const centibarEl = document.getElementById("centibar");
        const temperatureEl = document.getElementById("temperature");
        const statusEl = document.getElementById("status");

        const resistanceTsEl = document.getElementById("resistance-timestamp");
        const centibarTsEl = document.getElementById("centibar-timestamp");
        const temperatureTsEl = document.getElementById("temperature-timestamp");
        const statusTsEl = document.getElementById("status-timestamp");

        const statusCardEl = document.getElementById("status-card");
        const dataCards = document.querySelectorAll(".data-card");

        function updateStatusStyle(status) {
            statusCardEl.className = 'data-card p-6 rounded-xl shadow-lg transition duration-300 transform scale-100 ring-2 ring-transparent flex flex-col justify-between';
            let bgColor = 'bg-gray-400', ringColor = 'ring-gray-300';
            switch (status.toLowerCase()) {
                case 'wet': bgColor = 'bg-blue-600'; ringColor = 'ring-blue-300'; break;
                case 'optimal': bgColor = 'bg-green-600'; ringColor = 'ring-green-300'; break;
                case 'moderate stress': bgColor = 'bg-yellow-600'; ringColor = 'ring-yellow-300'; break;
                case 'severe stress':
                case 'dry': bgColor = 'bg-red-600'; ringColor = 'ring-red-300'; break;
            }
            statusCardEl.classList.add(bgColor, ringColor, 'ring-opacity-50');
        }

        function formatTimestamp(ts) {
            try {
                const date = new Date(ts);
                if (isNaN(date)) return { time: '--', date: 'Invalid Date' };
                return {
                    time: date.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' }),
                    date: date.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' })
                };
            } catch { return { time: '--', date: 'Error' }; }
        }

        onValue(sensorRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const { time } = formatTimestamp(data.timestamp);

                resistanceEl.innerText = data.resistance_kOhm.toFixed(2);
                centibarEl.innerText = data.centibar.toFixed(0);
                temperatureEl.innerText = data.temperature_C?.toFixed(1) ?? '--';
                statusEl.innerText = data.status ?? 'N/A';

                resistanceTsEl.innerText = `Last updated: ${time}`;
                centibarTsEl.innerText = `Last updated: ${time}`;
                temperatureTsEl.innerText = `Last updated: ${time}`;
                statusTsEl.innerText = `Last updated: ${time}`;

                updateStatusStyle(data.status ?? 'N/A');

                dataCards.forEach(card => {
                    card.classList.remove('pulse-on-update');
                    void card.offsetWidth;
                    card.classList.add('pulse-on-update');
                });
            }
        }, (error) => {
            console.error(error);
            resistanceEl.innerText = centibarEl.innerText = temperatureEl.innerText = 'Error';
            statusEl.innerText = 'Failed';
            updateStatusStyle('error');
        });
    </script>
</body>
</html>
